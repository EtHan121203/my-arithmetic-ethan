stages:
  - build
  - test
  - coverage

test:
  stage: test
  image: python:3.12
  script:
    - pip install hatch
    - hatch test

coverage:
  stage: coverage
  image: python:3.12
  script:
    - pip install hatch
    - hatch test --cover
  coverage: '/TOTAL.+?(\d+\%)$/'
  only:
    - main

build_stable:
  stage: build
  image: python:3.12
  script:
    - echo "Déploiement my-arithmetic-$USER sur les serveurs stables"
    - pip install hatch hatch-vcs
    - hatch build
    - ls dist/
  only:
    - tags

build_non_stable:
  stage: build
  image: python:3.12
  script:
    - echo "Déploiement my-arithmetic-$USER sur les serveurs develop"
    - pip install hatch hatch-vcs
    - hatch build
    - ls dist/
  only:
    - develop

sync-with-github:
  before_script:
    - apk add --no-cache git
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git config --global user.email "${GITLAB_USER_EMAIL}"
  script:
    - git remote remove github || true  # Supprimer le remote s'il existe déjà
    - git remote add github https://oauth2:${ACCESS_TOKEN}@github.com/Ethan121203/${CI_PROJECT_NAME}.git
    - git checkout main
    - git pull origin main
    - git pull github main
    - git status
    - git push https://root:$ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git HEAD:master